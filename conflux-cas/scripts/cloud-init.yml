#cloud-config
# =============================================================================
# conflux-cas — Hetzner CAX (ARM64 / Ampere) production cloud-init
# =============================================================================
#
# BEFORE USE: replace every @@PLACEHOLDER@@ with real values.
#
#   @@SSH_PUBLIC_KEY@@         your SSH public key  (ssh-ed25519 AAAA... or similar)
#   cfxdevkit.org                 public domain        (e.g. cas.example.com)
#   @@GIT_REMOTE@@             git clone URL        → https://github.com/cfxdevkit/cas.git
#   @@GIT_BRANCH@@             branch to deploy     → main
#   @@EXECUTOR_PRIVATE_KEY@@   0x-prefixed 64-hex keeper wallet key
#   @@WC_PROJECT_ID@@          WalletConnect Cloud project ID
#   @@CERTBOT_EMAIL@@          email for Let's Encrypt notifications
#   @@NETWORK@@                testnet  OR  mainnet
#
# JWT_SECRET is auto-generated by openssl during first boot.
# HTTPS certificate is issued by certbot at the end of runcmd.
# DNS for cfxdevkit.org must resolve to this server's IP BEFORE first boot,
# or certbot will fail silently and you can re-run it manually afterwards.
#
# Usage: paste the whole file into the Hetzner Console "User data" field
#        when creating the server (or: hcloud server create --user-data-from-file cloud-init.yml)
# =============================================================================

# ── Basic server identity ─────────────────────────────────────────────────────
hostname: cas-server
manage_etc_hosts: true

# ── Non-root deploy user ──────────────────────────────────────────────────────
users:
  - name: cas
    gecos: "conflux-cas deploy user"
    groups: [sudo, docker]
    shell: /bin/bash
    sudo: "ALL=(ALL) NOPASSWD:ALL"
    ssh_authorized_keys:
      - @@SSH_PUBLIC_KEY@@

ssh_pwauth: false
disable_root: true

# ── OS packages ──────────────────────────────────────────────────────────────
package_update: true
package_upgrade: true
packages:
  - curl
  - git
  - ufw
  - nginx
  - certbot
  - python3-certbot-nginx
  - sqlite3
  - ca-certificates
  - gnupg
  - logrotate
  - fail2ban

# ── Static files (nginx, systemd, logrotate) ─────────────────────────────────
# NOTE: .env is written in runcmd AFTER git clone to avoid blocking the clone.
write_files:

  # ── nginx: HTTP→HTTPS redirect + reverse-proxy ─────────────────────────────
  - path: /etc/nginx/sites-available/cas
    owner: root:root
    permissions: "0644"
    content: |
      # HTTP — redirect everything to HTTPS (certbot fills the SSL block below)
      server {
          listen 80;
          server_name cfxdevkit.org;
          return 301 https://$host$request_uri;
      }

      # HTTPS — filled in by: certbot --nginx -d cfxdevkit.org
      # (certbot appends/replaces this block automatically)
      server {
          listen 443 ssl;
          server_name cfxdevkit.org;

          # ── Frontend (Next.js on :3000) ─────────────────────────────────
          location / {
              proxy_pass         http://127.0.0.1:3000;
              proxy_http_version 1.1;
              proxy_set_header   Upgrade    $http_upgrade;
              proxy_set_header   Connection "upgrade";
              proxy_set_header   Host       $host;
              proxy_cache_bypass $http_upgrade;
          }

          # ── Backend API + SSE stream (on :3001) ─────────────────────────
          # Trailing slash on proxy_pass strips the /api prefix:
          #   /api/auth/nonce  →  http://127.0.0.1:3001/auth/nonce
          # proxy_buffering MUST be off for SSE to work (EventSource streams)
          location /api/ {
              proxy_pass             http://127.0.0.1:3001/;
              proxy_http_version     1.1;
              proxy_set_header       Connection         "";
              proxy_set_header       Host               $host;
              proxy_set_header       X-Real-IP          $remote_addr;
              proxy_set_header       X-Forwarded-For    $proxy_add_x_forwarded_for;
              proxy_set_header       X-Forwarded-Proto  $scheme;
              proxy_buffering        off;
              proxy_cache            off;
              proxy_read_timeout     86400s;
              proxy_send_timeout     86400s;
          }

          # ── Health check endpoint (no auth needed) ───────────────────────
          location /health {
              proxy_pass http://127.0.0.1:3001/health;
              access_log off;
          }
      }

  # ── systemd: auto-start docker compose on boot ───────────────────────────
  - path: /etc/systemd/system/conflux-cas.service
    owner: root:root
    permissions: "0644"
    content: |
      [Unit]
      Description=conflux-cas — docker compose application stack
      Documentation=https://github.com/cfxdevkit/cas
      After=docker.service network-online.target
      Wants=network-online.target
      Requires=docker.service

      [Service]
      Type=oneshot
      RemainAfterExit=yes
      User=cas
      Group=cas
      WorkingDirectory=/home/cas/repos/conflux-cas
      # Images are pulled from ghcr.io — no build on the server
      ExecStart=/usr/bin/docker compose -f docker-compose.prod.yml up -d
      ExecStop=/usr/bin/docker compose -f docker-compose.prod.yml down
      TimeoutStartSec=120
      Restart=on-failure
      RestartSec=10

      [Install]
      WantedBy=multi-user.target

  # ── logrotate: audit log produced by worker ──────────────────────────────
  - path: /etc/logrotate.d/conflux-audit
    owner: root:root
    permissions: "0644"
    content: |
      /data/audit.jsonl {
          daily
          rotate 30
          compress
          delaycompress
          missingok
          notifempty
          create 640 cas cas
          postrotate
              /usr/bin/docker compose -f /home/cas/repos/conflux-cas/docker-compose.prod.yml \
                  kill -s USR1 worker 2>/dev/null || true
          endscript
      }

  # ── fail2ban: protect SSH ────────────────────────────────────────────────
  - path: /etc/fail2ban/jail.local
    owner: root:root
    permissions: "0644"
    content: |
      [DEFAULT]
      bantime  = 3600
      findtime = 600
      maxretry = 5

      [sshd]
      enabled  = true
      port     = ssh
      logpath  = %(sshd_log)s

  # ── Docker daemon: log size limits ──────────────────────────────────────
  - path: /etc/docker/daemon.json
    owner: root:root
    permissions: "0644"
    content: |
      {
        "log-driver": "json-file",
        "log-opts": {
          "max-size": "20m",
          "max-file": "5"
        }
      }

# ── Boot-time setup ───────────────────────────────────────────────────────────
runcmd:

  # ── 1. Harden SSH ─────────────────────────────────────────────────────────
  - sed -i 's/^#*PasswordAuthentication.*/PasswordAuthentication no/'   /etc/ssh/sshd_config
  - sed -i 's/^#*PermitRootLogin.*/PermitRootLogin no/'                 /etc/ssh/sshd_config
  - sed -i 's/^#*PubkeyAuthentication.*/PubkeyAuthentication yes/'      /etc/ssh/sshd_config
  - sed -i 's/^#*MaxAuthTries.*/MaxAuthTries 3/'                        /etc/ssh/sshd_config
  - systemctl restart ssh

  # ── 2. Firewall ───────────────────────────────────────────────────────────
  - ufw --force reset
  - ufw default deny incoming
  - ufw default allow outgoing
  - ufw allow 22/tcp   comment 'SSH'
  - ufw allow 80/tcp   comment 'HTTP (nginx redirect to HTTPS)'
  - ufw allow 443/tcp  comment 'HTTPS'
  # Ports 3000/3001 are NOT opened — nginx proxies them from localhost only
  - ufw --force enable

  # ── 3. Install Docker (official repo, ARM64-aware) ────────────────────────
  - install -m 0755 -d /etc/apt/keyrings
  - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
  - chmod a+r /etc/apt/keyrings/docker.gpg
  - |
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] \
    https://download.docker.com/linux/ubuntu \
    $(. /etc/os-release && echo "$VERSION_CODENAME") stable" \
    > /etc/apt/sources.list.d/docker.list
  - apt-get update -qq
  - apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
  - systemctl enable --now docker
  - usermod -aG docker cas

  # ── 4. Persistent data directory (SQLite + audit log) ────────────────────
  - mkdir -p /data
  - chown cas:cas /data

  # ── 5. Clone monorepo ─────────────────────────────────────────────────────
  # The docker-compose.yml uses context: ".." so we need the full workspace.
  # HTTPS clone — no SSH key needed for a public repo.
  # The development remote (git@github.com:cfxdevkit/cas.git) is for local pushes only.
  - sudo -u cas git clone --branch main https://github.com/cfxdevkit/cas.git /home/cas/repos
  - chown -R cas:cas /home/cas/repos

  # ── 6. Write .env (JWT_SECRET auto-generated) ─────────────────────────────
  - |
    JWT_SECRET=$(openssl rand -hex 32)
    cat > /home/cas/repos/conflux-cas/.env << ENVEOF
    # Generated by cloud-init on $(date -u +%Y-%m-%dT%H:%M:%SZ)
    # Edit carefully — services restart on next: docker compose up -d

    # ── Backend ────────────────────────────────────────────────────────────
    DATABASE_PATH=/data/cas.db
    JWT_SECRET=${JWT_SECRET}
    PORT=3001
    CORS_ORIGIN=https://cfxdevkit.org

    # ── Worker ─────────────────────────────────────────────────────────────
    EXECUTOR_PRIVATE_KEY=@@EXECUTOR_PRIVATE_KEY@@
    CONFLUX_ESPACE_TESTNET_RPC=https://evmtestnet.confluxrpc.com
    CONFLUX_ESPACE_MAINNET_RPC=https://evm.confluxrpc.com
    NETWORK=@@NETWORK@@
    WORKER_POLL_INTERVAL_MS=15000
    MAX_GAS_PRICE_GWEI=1000
    JOB_BATCH_SIZE=50
    AUDIT_LOG_PATH=/data/audit.jsonl

    # ── Contracts (testnet chain 71) ────────────────────────────────────────
    AUTOMATION_MANAGER_ADDRESS=0x33e5e5b262e5d8ebc443e1c6c9f14215b020554d
    PRICE_ADAPTER_ADDRESS=0x88c48e0e8f76493bb926131a2be779cc17ecbedf
    PERMIT_HANDLER_ADDRESS=0x4240882f2d9d70cdb9fbcc859cdd4d3e59f5d137

    # ── Contracts (mainnet chain 1030) — uncomment when NETWORK=mainnet ────
    # AUTOMATION_MANAGER_ADDRESS=0x9D5B131e5bA37A238cd1C485E2D9d7c2A68E1d0F
    # PRICE_ADAPTER_ADDRESS=0xD2Cc2a7Eb4A5792cE6383CcD0f789C1A9c48ECf9
    # PERMIT_HANDLER_ADDRESS=0x0D566aC9Dd1e20Fc63990bEEf6e8abBA876c896B

    # ── Frontend ───────────────────────────────────────────────────────────
    BACKEND_URL=http://backend:3001
    NEXT_PUBLIC_WC_PROJECT_ID=@@WC_PROJECT_ID@@
    NEXT_PUBLIC_API_URL=https://cfxdevkit.org
    NEXT_PUBLIC_NETWORK=@@NETWORK@@
    NEXT_PUBLIC_AUTOMATION_MANAGER_ADDRESS=0x33e5e5b262e5d8ebc443e1c6c9f14215b020554d
    ENVEOF
    chmod 600 /home/cas/repos/conflux-cas/.env
    chown cas:cas /home/cas/repos/conflux-cas/.env

  # ── 7. nginx — enable site, remove default ────────────────────────────────
  - ln -sf /etc/nginx/sites-available/cas /etc/nginx/sites-enabled/cas
  - rm -f /etc/nginx/sites-enabled/default
  - nginx -t
  - systemctl enable --now nginx

  # ── 8. Pull pre-built docker images from ghcr.io ────────────────────────
  - |
    cd /home/cas/repos/conflux-cas
    sudo -u cas docker compose -f docker-compose.prod.yml pull 2>&1 | tee /var/log/conflux-cas-pull.log

  # ── 9. Start the stack ───────────────────────────────────────────────────
  - |
    cd /home/cas/repos/conflux-cas
    sudo -u cas docker compose -f docker-compose.prod.yml up -d

  # ── 10. Enable systemd service for auto-start on reboot ──────────────────
  - systemctl daemon-reload
  - systemctl enable conflux-cas
  - systemctl enable fail2ban
  - systemctl restart fail2ban

  # ── 11. Issue TLS certificate via Let's Encrypt ────────────────────────
  # Requires cfxdevkit.org DNS A record already pointing at this IP.
  # If DNS is not ready yet, this step is skipped and you can run it manually:
  #   sudo certbot --nginx -d cfxdevkit.org --non-interactive --agree-tos -m @@CERTBOT_EMAIL@@
  - |
    if host cfxdevkit.org | grep -q "$(curl -s https://api.ipify.org)"; then
      certbot --nginx \
        --non-interactive \
        --agree-tos \
        --redirect \
        -d cfxdevkit.org \
        -m @@CERTBOT_EMAIL@@ \
        && systemctl reload nginx \
        && echo "TLS certificate issued successfully."
    else
      echo "WARN: cfxdevkit.org does not resolve to this server — skipping certbot."
      echo "      Run manually once DNS propagates:"
      echo "      sudo certbot --nginx -d cfxdevkit.org --non-interactive --agree-tos -m @@CERTBOT_EMAIL@@"
    fi

# ── Cloud-init completion message (visible in: sudo cloud-init status --long) ─
final_message: |
  ╔══════════════════════════════════════════════════════════════════╗
  ║          conflux-cas cloud-init complete                        ║
  ╠══════════════════════════════════════════════════════════════════╣
  ║  Pull log  : /var/log/conflux-cas-pull.log                      ║
  ║  Stack logs: ssh cas@<IP> then: docker compose logs -f          ║
  ╠══════════════════════════════════════════════════════════════════╣
  ║  NEXT STEPS                                                      ║
  ║  1. Verify DNS: cfxdevkit.org → this server IP                  ║
  ║  2. If TLS was skipped:                                         ║
  ║       sudo certbot --nginx -d cfxdevkit.org                     ║
  ║  3. Check stack health:                                         ║
  ║       cd ~/repos/conflux-cas                                    ║
  ║       docker compose -f docker-compose.prod.yml ps              ║
  ║  4. Tail logs:                                                  ║
  ║       docker compose -f docker-compose.prod.yml logs -f         ║
  ╚══════════════════════════════════════════════════════════════════╝
